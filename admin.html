<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Admin - Resenha Music</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000;
            color: #f5f5f7;
        }
        .stat-card {
            background-color: #1c1c1e;
            border-radius: 16px;
        }
        .table-container {
            background-color: #1c1c1e;
            border-radius: 16px;
        }
        th {
            background-color: #333336;
        }
    </style>
</head>
<body class="bg-black">
    <div id="loading-overlay" class="fixed inset-0 bg-black flex items-center justify-center z-50">
        <div class="w-12 h-12 border-4 border-gray-700 border-t-white rounded-full animate-spin"></div>
    </div>

    <div id="content" class="hidden">
        <header class="bg-[#1c1c1e] p-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-white">Painel Resenha Music</h1>
            <button id="logout-button" class="text-sm text-red-500 hover:text-red-400">Sair</button>
        </header>

        <main class="p-4 sm:p-8">
            <!-- Métricas Principais -->
            <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="stat-card p-6">
                    <h3 class="text-sm font-medium text-gray-400">RECEITA CONFIRMADA</h3>
                    <p id="revenue-paid" class="text-3xl font-bold text-green-500 mt-2">R$ 0,00</p>
                </div>
                <div class="stat-card p-6">
                    <h3 class="text-sm font-medium text-gray-400">INSCRIÇÕES PAGAS</h3>
                    <p id="inscriptions-paid" class="text-3xl font-bold text-white mt-2">0</p>
                </div>
                <div class="stat-card p-6">
                    <h3 class="text-sm font-medium text-gray-400">INSCRIÇÕES PENDENTES</h3>
                    <p id="inscriptions-pending" class="text-3xl font-bold text-yellow-500 mt-2">0</p>
                </div>
                <div class="stat-card p-6">
                    <h3 class="text-sm font-medium text-gray-400">TOTAL DE INSCRITOS</h3>
                    <p id="inscriptions-total" class="text-3xl font-bold text-blue-500 mt-2">0</p>
                </div>
            </section>

            <!-- Gráficos -->
            <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="stat-card p-6">
                    <h3 class="text-lg font-semibold text-white mb-4">Estado das Inscrições</h3>
                    <canvas id="status-chart"></canvas>
                </div>
                <div class="stat-card p-6">
                    <h3 class="text-lg font-semibold text-white mb-4">Tipos de Bilhete (Pagos)</h3>
                    <canvas id="ticket-chart"></canvas>
                </div>
            </section>

            <!-- Tabela de Inscrições -->
            <section class="table-container overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="text-xs text-gray-300 uppercase">
                        <tr>
                            <th class="p-4">Nome do Comprador</th>
                            <th class="p-4">E-mail</th>
                            <th class="p-4">Qtd.</th>
                            <th class="p-4">Tipo</th>
                            <th class="p-4">Total</th>
                            <th class="p-4">Estado</th>
                            <th class="p-4">Data</th>
                        </tr>
                    </thead>
                    <tbody id="inscriptions-table-body">
                        <!-- Linhas serão inseridas aqui via JavaScript -->
                    </tbody>
                </table>
            </section>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const loadingOverlay = document.getElementById('loading-overlay');
            const contentDiv = document.getElementById('content');
            const logoutButton = document.getElementById('logout-button');

            // 1. Verifica se o utilizador está autenticado
            const authToken = sessionStorage.getItem('admin-auth-token');
            if (!authToken) {
                window.location.href = '/login.html';
                return;
            }

            logoutButton.addEventListener('click', () => {
                sessionStorage.removeItem('admin-auth-token');
                window.location.href = '/login.html';
            });

            // 2. Busca os dados das inscrições
            try {
                const response = await fetch('/api/get-inscriptions');
                if (!response.ok) {
                    throw new Error('Não foi possível carregar os dados.');
                }
                const inscriptions = await response.json();
                
                // 3. Processa e exibe os dados
                displayData(inscriptions);

                // 4. Esconde o loading e mostra o conteúdo
                loadingOverlay.classList.add('hidden');
                contentDiv.classList.remove('hidden');

            } catch (error) {
                console.error(error);
                loadingOverlay.innerHTML = `<p class="text-red-500">${error.message}</p>`;
            }
        });

        function displayData(inscriptions) {
            // Métricas
            const revenuePaidEl = document.getElementById('revenue-paid');
            const inscriptionsPaidEl = document.getElementById('inscriptions-paid');
            const inscriptionsPendingEl = document.getElementById('inscriptions-pending');
            const inscriptionsTotalEl = document.getElementById('inscriptions-total');
            
            let revenuePaid = 0;
            let inscriptionsPaidCount = 0;
            let inscriptionsPendingCount = 0;
            let paidTicketTypes = { pista: 0, vip: 0 };

            inscriptions.forEach(item => {
                if (item.paymentStatus === 'paid') {
                    inscriptionsPaidCount++;
                    revenuePaid += item.total_price;
                    paidTicketTypes[item.ticket_type] += item.quantity;
                } else {
                    inscriptionsPendingCount++;
                }
            });

            revenuePaidEl.textContent = revenuePaid.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            inscriptionsPaidEl.textContent = inscriptionsPaidCount;
            inscriptionsPendingEl.textContent = inscriptionsPendingCount;
            inscriptionsTotalEl.textContent = inscriptions.length;

            // Tabela
            const tableBody = document.getElementById('inscriptions-table-body');
            tableBody.innerHTML = ''; // Limpa a tabela
            inscriptions.forEach(item => {
                const statusClass = item.paymentStatus === 'paid' ? 'text-green-500' : 'text-yellow-500';
                const date = new Date(item.createdAt).toLocaleDateString('pt-BR');

                const row = `
                    <tr class="border-b border-gray-700">
                        <td class="p-4 font-medium text-white">${item.mainParticipant.name}</td>
                        <td class="p-4 text-gray-400">${item.mainParticipant.email}</td>
                        <td class="p-4 text-gray-400">${item.quantity}</td>
                        <td class="p-4 text-gray-400 uppercase">${item.ticket_type}</td>
                        <td class="p-4 text-gray-400">${item.total_price.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                        <td class="p-4 font-semibold ${statusClass}">${item.paymentStatus.toUpperCase()}</td>
                        <td class="p-4 text-gray-400">${date}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

            // Gráficos
            const statusCtx = document.getElementById('status-chart').getContext('2d');
            new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Pagos', 'Pendentes'],
                    datasets: [{
                        data: [inscriptionsPaidCount, inscriptionsPendingCount],
                        backgroundColor: ['#22c55e', '#eab308'],
                        borderColor: '#1c1c1e',
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { labels: { color: '#f5f5f7' } } }
                }
            });

            const ticketCtx = document.getElementById('ticket-chart').getContext('2d');
            new Chart(ticketCtx, {
                type: 'bar',
                data: {
                    labels: ['Pista', 'VIP'],
                    datasets: [{
                        label: 'Bilhetes Pagos',
                        data: [paidTicketTypes.pista, paidTicketTypes.vip],
                        backgroundColor: ['#3b82f6', '#8b5cf6'],
                        borderColor: '#1c1c1e',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { ticks: { color: '#9ca3af', stepSize: 1 } },
                        x: { ticks: { color: '#f5f5f7' } }
                    }
                }
            });
        }
    </script>
</body>
</html>
