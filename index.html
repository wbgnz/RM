<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inscrição - Resenha Music</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000;
            color: #f5f5f7;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background-image: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('https://raw.githubusercontent.com/wbgnz/BDIMG/main/Logo%20Resenha.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center center;
            z-index: -1;
        }

        .form-container {
            background: rgba(28, 28, 30, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            position: relative;
            z-index: 10;
        }

        .form-input {
            background-color: #333336;
            border: 1px solid #4a4a4f;
            color: #f5f5f7;
            transition: border-color 0.3s, box-shadow 0.3s;
            border-radius: 12px;
        }

        .form-input:focus {
            outline: none;
            border-color: #0a84ff;
            box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.3);
        }
        
        .segmented-control {
            display: flex;
            background-color: #333336;
            border-radius: 12px;
            padding: 4px;
        }
        
        .ticket-radio:checked + .segmented-label {
            background-color: #636366;
            color: #ffffff;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .segmented-label {
            flex: 1;
            text-align: center;
            padding: 10px 0;
            border-radius: 9px;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
            color: #a1a1a6;
        }
        
        .participant-enter {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .floating-button-container.visible {
            transform: translateY(0);
        }

    </style>
</head>
<body class="p-4">

    <main class="w-full max-w-lg mx-auto z-10 pt-24 pb-24">
        <div class="form-container p-6 sm:p-10 shadow-2xl">
            <!-- Cabeçalho -->
            <div class="text-center mb-10">
                <img src="https://raw.githubusercontent.com/wbgnz/BDIMG/d92bd032a164c0846da94b6fbdd731fe4693350c/RESENHA.png" alt="Logo Resenha Music" class="h-32 mx-auto mb-4">
                <p class="text-lg text-gray-400">Preencha os seus dados para garantir a sua vaga.</p>
            </div>

            <!-- Formulário -->
            <form id="inscription-form" novalidate>
                <div class="space-y-6">
                    <h3 class="text-xl font-semibold text-white border-b border-gray-700 pb-2">Participante 1 (Comprador)</h3>
                    <div>
                        <label for="name" class="block mb-2 text-sm font-medium text-gray-400">Nome Completo</label>
                        <input type="text" id="name" name="name" class="form-input w-full p-3" required>
                    </div>
                     <div>
                        <label for="email" class="block mb-2 text-sm font-medium text-gray-400">E-mail</label>
                        <input type="email" id="email" name="email" class="form-input w-full p-3" required>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="whatsapp" class="block mb-2 text-sm font-medium text-gray-400">WhatsApp</label>
                            <input type="tel" id="whatsapp" name="whatsapp" class="form-input w-full p-3" placeholder="(99) 99999-9999" required>
                        </div>
                        <div>
                            <label for="birthdate" class="block mb-2 text-sm font-medium text-gray-400">Data de Nascimento</label>
                            <input type="date" id="birthdate" name="birthdate" class="form-input w-full p-3" required style="color-scheme: dark;">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="cpf" class="block mb-2 text-sm font-medium text-gray-400">CPF</label>
                            <input type="text" id="cpf" name="cpf" class="form-input w-full p-3" placeholder="000.000.000-00" required>
                        </div>
                        <div>
                            <label for="cep" class="block mb-2 text-sm font-medium text-gray-400">CEP</label>
                            <input type="text" id="cep" name="cep" class="form-input w-full p-3" placeholder="00000-000" required>
                        </div>
                    </div>
                </div>

                <div id="additional-participants-container" class="space-y-8 mt-8"></div>

                <div class="mt-8">
                    <h3 class="text-sm font-medium text-gray-400 mb-2">Tipo de Bilhete</h3>
                    <div class="segmented-control">
                        <input type="radio" name="ticket_type" id="pista" value="pista" class="hidden ticket-radio" checked>
                        <label for="pista" class="segmented-label">
                            <span class="font-semibold">Pista</span>
                            <span class="block text-xs">R$ 99,90</span>
                        </label>
                        <input type="radio" name="ticket_type" id="vip" value="vip" class="hidden ticket-radio">
                        <label for="vip" class="segmented-label">
                            <span class="font-semibold">VIP</span>
                            <span class="block text-xs">R$ 149,90</span>
                        </label>
                    </div>
                </div>

                <div class="mt-8 border-t border-gray-700 pt-6">
                    <label for="coupon" class="block mb-2 text-sm font-medium text-gray-400">Cupom de Desconto</label>
                    <div class="flex space-x-2">
                        <input type="text" id="coupon" name="coupon" class="form-input w-full p-3 uppercase" placeholder="INSIRA O SEU CÓDIGO">
                        <button type="button" id="apply-coupon-btn" class="bg-gray-600 text-white font-semibold px-5 rounded-lg hover:bg-gray-500 transition-colors">Aplicar</button>
                    </div>
                    <p id="coupon-message" class="text-sm mt-2 h-5"></p>
                </div>

                <div class="mt-4 flex flex-col space-y-4 sm:space-y-0 sm:flex-row sm:items-center justify-between border-t border-gray-700 pt-6">
                    <div class="flex items-center">
                        <label class="text-base font-medium text-white mr-4">Quantidade</label>
                        <div class="flex items-center bg-[#333336] rounded-lg">
                            <button type="button" id="decrease-qty" class="w-10 h-10 text-2xl font-medium text-gray-300 hover:text-white transition-colors">-</button>
                            <span id="quantity" class="w-10 text-center text-lg font-semibold text-white">1</span>
                            <button type="button" id="increase-qty" class="w-10 h-10 text-2xl font-medium text-gray-300 hover:text-white transition-colors">+</button>
                        </div>
                    </div>
                    <div class="text-center sm:text-right">
                        <span class="text-sm text-gray-400 block">Total</span>
                        <span id="total-price" class="text-3xl font-bold text-white">R$ 99,90</span>
                    </div>
                </div>

                <div class="mt-10">
                    <button type="submit" id="submit-button" class="w-full bg-[#0a84ff] text-white font-semibold text-lg py-4 rounded-xl shadow-lg hover:bg-[#0077ed] transition-all duration-300">
                        Continuar para Pagamento
                    </button>
                </div>
                 <div id="loading-overlay" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex-col items-center justify-center z-50">
                    <div class="w-12 h-12 border-4 border-gray-500 border-t-white rounded-full animate-spin"></div>
                    <p class="text-white text-lg mt-4">A processar...</p>
                </div>
            </form>
        </div>
    </main>
    
    <div id="floating-button-container" class="fixed bottom-0 left-0 w-full p-4 z-20 transition-transform duration-300 translate-y-full bg-black/50 backdrop-blur-sm border-t border-gray-800">
        <button id="floating-submit-button" class="w-full max-w-lg mx-auto block bg-[#0a84ff] text-white font-semibold text-lg py-4 rounded-xl shadow-lg hover:bg-[#0077ed] transition-all duration-300">
            Continuar para Pagamento
        </button>
    </div>

    <div class="h-screen"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('inscription-form');
            const floatingButtonContainer = document.getElementById('floating-button-container');
            const floatingSubmitButton = document.getElementById('floating-submit-button');
            const mainFormButton = document.getElementById('submit-button');

            window.addEventListener('scroll', () => {
                const mainButtonRect = mainFormButton.getBoundingClientRect();
                if (mainButtonRect.top < window.innerHeight && mainButtonRect.bottom < 0) {
                    floatingButtonContainer.classList.add('visible');
                } else {
                    floatingButtonContainer.classList.remove('visible');
                }
            });

            floatingSubmitButton.addEventListener('click', () => {
                form.requestSubmit();
            });

            const ticketTypeRadios = document.querySelectorAll('input[name="ticket_type"]');
            const quantitySpan = document.getElementById('quantity');
            const decreaseBtn = document.getElementById('decrease-qty');
            const increaseBtn = document.getElementById('increase-qty');
            const totalPriceSpan = document.getElementById('total-price');
            const loadingOverlay = document.getElementById('loading-overlay');
            const participantsContainer = document.getElementById('additional-participants-container');
            const couponInput = document.getElementById('coupon');
            const applyCouponBtn = document.getElementById('apply-coupon-btn');
            const couponMessage = document.getElementById('coupon-message');

            const ticketPrices = {
                pista: 99.90,
                vip: 149.90
            };

            let currentQuantity = 1;
            let appliedCoupon = null;
            let isVoucher = false;

            function formatCurrency(value) {
                return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            }

            function updateTotalPrice() {
                const selectedTicketType = document.querySelector('input[name="ticket_type"]:checked').value;
                const pricePerTicket = ticketPrices[selectedTicketType];
                let total = pricePerTicket * currentQuantity;
                isVoucher = false;

                if (appliedCoupon) {
                    if (appliedCoupon.type === 'percentage') {
                        total *= (1 - appliedCoupon.value / 100);
                    } else if (appliedCoupon.type === 'fixed') {
                        total -= appliedCoupon.value;
                    }
                }
                
                total = Math.max(0, total);
                totalPriceSpan.textContent = formatCurrency(total);

                // Muda o texto do botão se o total for zero
                if (total === 0 && appliedCoupon) {
                    isVoucher = true;
                    mainFormButton.textContent = 'Solicitar Inscrição Gratuita';
                    floatingSubmitButton.textContent = 'Solicitar Inscrição Gratuita';
                } else {
                    mainFormButton.textContent = 'Continuar para Pagamento';
                    floatingSubmitButton.textContent = 'Continuar para Pagamento';
                }
            }

            applyCouponBtn.addEventListener('click', async () => {
                const couponCode = couponInput.value;
                if (!couponCode) return;

                applyCouponBtn.disabled = true;
                applyCouponBtn.textContent = '...';
                couponMessage.textContent = '';

                try {
                    const response = await fetch('/api/validate-coupon', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ couponCode })
                    });
                    const data = await response.json();

                    if (response.ok && data.success) {
                        appliedCoupon = data.coupon;
                        couponMessage.textContent = 'Cupom aplicado com sucesso!';
                        couponMessage.className = 'text-green-500 text-sm mt-2 h-5';
                        updateTotalPrice();
                    } else {
                        throw new Error(data.error || 'Cupom inválido');
                    }
                } catch (error) {
                    appliedCoupon = null;
                    couponMessage.textContent = error.message;
                    couponMessage.className = 'text-red-500 text-sm mt-2 h-5';
                    updateTotalPrice();
                } finally {
                    applyCouponBtn.disabled = false;
                    applyCouponBtn.textContent = 'Aplicar';
                }
            });

            function addParticipantForm(participantNumber) {
                const newParticipantDiv = document.createElement('div');
                newParticipantDiv.classList.add('space-y-6', 'participant-enter');
                newParticipantDiv.innerHTML = `
                    <h3 class="text-xl font-semibold text-white border-b border-gray-700 pb-2">Participante ${participantNumber}</h3>
                    <div>
                        <label for="name_${participantNumber}" class="block mb-2 text-sm font-medium text-gray-400">Nome Completo</label>
                        <input type="text" id="name_${participantNumber}" name="name_${participantNumber}" class="form-input w-full p-3" required>
                    </div>
                    <div>
                        <label for="whatsapp_${participantNumber}" class="block mb-2 text-sm font-medium text-gray-400">WhatsApp</label>
                        <input type="tel" id="whatsapp_${participantNumber}" name="whatsapp_${participantNumber}" class="form-input w-full p-3" placeholder="(99) 99999-9999" required>
                    </div>
                `;
                participantsContainer.appendChild(newParticipantDiv);
                
                const newWhatsappInput = newParticipantDiv.querySelector(`#whatsapp_${participantNumber}`);
                applyMask(newWhatsappInput, maskWhatsapp);
            }

            function removeLastParticipantForm() {
                const lastParticipant = participantsContainer.lastElementChild;
                if (lastParticipant) {
                    participantsContainer.removeChild(lastParticipant);
                }
            }

            increaseBtn.addEventListener('click', () => {
                currentQuantity++;
                quantitySpan.textContent = currentQuantity;
                addParticipantForm(currentQuantity);
                updateTotalPrice();
            });

            decreaseBtn.addEventListener('click', () => {
                if (currentQuantity > 1) {
                    removeLastParticipantForm();
                    currentQuantity--;
                    quantitySpan.textContent = currentQuantity;
                    updateTotalPrice();
                }
            });
            
            ticketTypeRadios.forEach(radio => {
                radio.addEventListener('change', updateTotalPrice);
            });

            function applyMask(inputElement, maskFunction) {
                inputElement.addEventListener('input', (e) => {
                    e.target.value = maskFunction(e.target.value);
                });
            }

            function maskWhatsapp(value) {
                value = value.replace(/\D/g, '').slice(0, 11);
                if (value.length > 10) {
                    return value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                } else if (value.length > 6) {
                    return value.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
                } else if (value.length > 2) {
                    return value.replace(/(\d{2})(\d*)/, '($1) $2');
                }
                return value;
            }

            function maskCPF(value) {
                value = value.replace(/\D/g, '').slice(0, 11);
                if (value.length > 9) {
                    return value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
                } else if (value.length > 6) {
                    return value.replace(/(\d{3})(\d{3})(\d{1,3})/, '$1.$2.$3');
                } else if (value.length > 3) {
                    return value.replace(/(\d{3})(\d{1,3})/, '$1.$2');
                }
                return value;
            }

            function maskCEP(value) {
                value = value.replace(/\D/g, '').slice(0, 8);
                if (value.length > 5) {
                    return value.replace(/(\d{5})(\d{1,3})/, '$1-$2');
                }
                return value;
            }
            
            applyMask(document.getElementById('whatsapp'), maskWhatsapp);
            applyMask(document.getElementById('cpf'), maskCPF);
            applyMask(document.getElementById('cep'), maskCEP);
            
            function applyWhatsappMask(inputElement) {
                applyMask(inputElement, maskWhatsapp);
            }

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                
                loadingOverlay.classList.remove('hidden');
                loadingOverlay.classList.add('flex');

                const formData = new FormData(form);
                const mainParticipant = {
                    name: formData.get('name'),
                    email: formData.get('email'),
                    whatsapp: formData.get('whatsapp'),
                    birthdate: formData.get('birthdate'),
                    cpf: formData.get('cpf'),
                    cep: formData.get('cep'),
                };
                
                const additionalParticipants = [];
                for (let i = 2; i <= currentQuantity; i++) {
                    additionalParticipants.push({
                        name: formData.get(`name_${i}`),
                        whatsapp: formData.get(`whatsapp_${i}`)
                    });
                }

                const submissionData = {
                    mainParticipant: mainParticipant,
                    additionalParticipants: additionalParticipants,
                    ticket_type: formData.get('ticket_type'),
                    quantity: currentQuantity,
                    coupon: appliedCoupon
                };
                
                // Decide para qual endpoint enviar os dados
                const endpoint = isVoucher ? '/api/request-voucher-inscription' : '/api/create-preference';
                
                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(submissionData)
                    });

                    const responseData = await response.json();

                    if (!response.ok) {
                        throw new Error(responseData.details || responseData.error || 'Falha na comunicação com o servidor');
                    }
                    
                    if (isVoucher) {
                        // Se for um voucher, redireciona para uma página de sucesso específica
                        window.location.href = '/voucher-sucesso.html';
                    } else if (responseData.init_point) {
                        window.location.href = responseData.init_point;
                    } else {
                        throw new Error('Link de pagamento não recebido.');
                    }
                } catch (error) {
                    console.error("Erro ao processar:", error);
                    alert(`Ocorreu um erro: ${error.message}`);
                    loadingOverlay.classList.add('hidden');
                    loadingOverlay.classList.remove('flex');
                }
            });

            updateTotalPrice();
        });
    </script>
</body>
</html>
