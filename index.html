<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inscrição - Resenha Music</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000;
            color: #f5f5f7;
            overflow-x: hidden;
        }

        #particle-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }

        .form-container {
            background-color: #1c1c1e;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            position: relative;
            z-index: 10;
        }

        .form-input {
            background-color: #333336;
            border: 1px solid #4a4a4f;
            color: #f5f5f7;
            transition: border-color 0.3s, box-shadow 0.3s;
            border-radius: 12px;
        }

        .form-input:focus {
            outline: none;
            border-color: #0a84ff;
            box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.3);
        }
        
        .segmented-control {
            display: flex;
            background-color: #333336;
            border-radius: 12px;
            padding: 4px;
        }
        
        .ticket-radio:checked + .segmented-label {
            background-color: #636366;
            color: #ffffff;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .segmented-label {
            flex: 1;
            text-align: center;
            padding: 10px 0;
            border-radius: 9px;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
            color: #a1a1a6;
        }
        
        .participant-enter {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <canvas id="particle-canvas"></canvas>

    <main class="w-full max-w-lg mx-auto z-10">
        <div class="form-container p-6 sm:p-10 shadow-2xl">
            <!-- Cabeçalho -->
            <div class="text-center mb-10">
                <img src="https://raw.githubusercontent.com/wbgnz/BDIMG/d92bd032a164c0846da94b6fbdd731fe4693350c/RESENHA.png" alt="Logo Resenha Music" class="h-32 mx-auto mb-6">
                <p class="text-lg text-gray-400 mt-3">Preencha os seus dados para garantir a sua vaga.</p>
            </div>

            <!-- Formulário -->
            <form id="inscription-form" novalidate>
                <div class="space-y-6">
                    <h3 class="text-xl font-semibold text-white border-b border-gray-700 pb-2">Participante 1 (Comprador)</h3>
                    <div>
                        <label for="name" class="block mb-2 text-sm font-medium text-gray-400">Nome Completo</label>
                        <input type="text" id="name" name="name" class="form-input w-full p-3" required>
                    </div>
                     <div>
                        <label for="email" class="block mb-2 text-sm font-medium text-gray-400">E-mail</label>
                        <input type="email" id="email" name="email" class="form-input w-full p-3" required>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="whatsapp" class="block mb-2 text-sm font-medium text-gray-400">WhatsApp</label>
                            <input type="tel" id="whatsapp" name="whatsapp" class="form-input w-full p-3" placeholder="(99) 99999-9999" required>
                        </div>
                        <div>
                            <label for="birthdate" class="block mb-2 text-sm font-medium text-gray-400">Data de Nascimento</label>
                            <input type="date" id="birthdate" name="birthdate" class="form-input w-full p-3" required style="color-scheme: dark;">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="cpf" class="block mb-2 text-sm font-medium text-gray-400">CPF</label>
                            <input type="text" id="cpf" name="cpf" class="form-input w-full p-3" placeholder="000.000.000-00" required>
                        </div>
                        <div>
                            <label for="cep" class="block mb-2 text-sm font-medium text-gray-400">CEP</label>
                            <input type="text" id="cep" name="cep" class="form-input w-full p-3" placeholder="00000-000" required>
                        </div>
                    </div>
                </div>

                <div id="additional-participants-container" class="space-y-8 mt-8"></div>

                <div class="mt-8">
                    <h3 class="text-sm font-medium text-gray-400 mb-2">Tipo de Bilhete</h3>
                    <div class="segmented-control">
                        <input type="radio" name="ticket_type" id="pista" value="pista" class="hidden ticket-radio" checked>
                        <label for="pista" class="segmented-label">
                            <span class="font-semibold">Pista</span>
                            <span class="block text-xs">R$ 1,00</span>
                        </label>
                        <input type="radio" name="ticket_type" id="vip" value="vip" class="hidden ticket-radio">
                        <label for="vip" class="segmented-label">
                            <span class="font-semibold">VIP</span>
                            <span class="block text-xs">R$ 2,00</span>
                        </label>
                    </div>
                </div>

                <div class="mt-8 flex items-center justify-between border-t border-gray-700 pt-6">
                    <div class="flex items-center">
                        <label class="text-base font-medium text-white mr-4">Quantidade</label>
                        <div class="flex items-center bg-[#333336] rounded-lg">
                            <button type="button" id="decrease-qty" class="w-10 h-10 text-2xl font-medium text-gray-300 hover:text-white transition-colors">-</button>
                            <span id="quantity" class="w-10 text-center text-lg font-semibold text-white">1</span>
                            <button type="button" id="increase-qty" class="w-10 h-10 text-2xl font-medium text-gray-300 hover:text-white transition-colors">+</button>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="text-sm text-gray-400 block">Total</span>
                        <span id="total-price" class="text-3xl font-bold text-white">R$ 1,00</span>
                    </div>
                </div>

                <div class="mt-10">
                    <button type="submit" id="submit-button" class="w-full bg-[#0a84ff] text-white font-semibold text-lg py-4 rounded-xl shadow-lg hover:bg-[#0077ed] transition-all duration-300">
                        Continuar para Pagamento
                    </button>
                </div>
                 <div id="loading-overlay" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex-col items-center justify-center z-50">
                    <div class="w-12 h-12 border-4 border-gray-500 border-t-white rounded-full animate-spin"></div>
                    <p class="text-white text-lg mt-4">A processar...</p>
                </div>
            </form>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('particle-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            let particlesArray;

            class Particle {
                constructor() {
                    this.reset();
                }
                
                reset() {
                    this.x = Math.random() * canvas.width;
                    this.y = Math.random() * canvas.height;
                    this.baseSize = (Math.random() * 10) + 8; // Tamanho base da fonte
                    this.maxLife = Math.random() * 200 + 100; // Duração de vida entre 100 e 300 frames
                    this.life = this.maxLife;
                }

                draw() {
                    // Calcula o progresso do ciclo de vida (0 -> 1 -> 0)
                    const progress = (this.maxLife - this.life) / this.maxLife;
                    const scale = Math.sin(progress * Math.PI);

                    // O tamanho e a opacidade aumentam e diminuem
                    const currentSize = this.baseSize * scale;
                    const opacity = scale * 0.2; // Opacidade máxima de 20%

                    if (currentSize > 1) {
                        ctx.font = `bold ${currentSize}px Inter`;
                        ctx.fillStyle = `rgba(255, 255, 255, ${opacity})`;
                        ctx.fillText('?', this.x, this.y);
                    }
                }

                update() {
                    this.life -= 1;
                    if (this.life <= 0) {
                        this.reset();
                    }
                    this.draw();
                }
            }

            function initParticles() {
                particlesArray = [];
                let numberOfParticles = (canvas.height * canvas.width) / 10000;
                for (let i = 0; i < numberOfParticles; i++) {
                    particlesArray.push(new Particle());
                }
            }

            function animateParticles() {
                requestAnimationFrame(animateParticles);
                ctx.clearRect(0, 0, innerWidth, innerHeight);
                for (let i = 0; i < particlesArray.length; i++) {
                    particlesArray[i].update();
                }
            }
            
            window.addEventListener('resize', () => {
                canvas.width = innerWidth;
                canvas.height = innerHeight;
                initParticles();
            });

            initParticles();
            animateParticles();

            const form = document.getElementById('inscription-form');
            const ticketTypeRadios = document.querySelectorAll('input[name="ticket_type"]');
            const quantitySpan = document.getElementById('quantity');
            const decreaseBtn = document.getElementById('decrease-qty');
            const increaseBtn = document.getElementById('increase-qty');
            const totalPriceSpan = document.getElementById('total-price');
            const loadingOverlay = document.getElementById('loading-overlay');
            const participantsContainer = document.getElementById('additional-participants-container');

            const ticketPrices = {
                pista: 1.00,
                vip: 2.00
            };

            let currentQuantity = 1;

            function formatCurrency(value) {
                return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            }

            function updateTotalPrice() {
                const selectedTicketType = document.querySelector('input[name="ticket_type"]:checked').value;
                const pricePerTicket = ticketPrices[selectedTicketType];
                const total = pricePerTicket * currentQuantity;
                totalPriceSpan.textContent = formatCurrency(total);
            }

            function addParticipantForm(participantNumber) {
                const newParticipantDiv = document.createElement('div');
                newParticipantDiv.classList.add('space-y-6', 'participant-enter');
                newParticipantDiv.innerHTML = `
                    <h3 class="text-xl font-semibold text-white border-b border-gray-700 pb-2">Participante ${participantNumber}</h3>
                    <div>
                        <label for="name_${participantNumber}" class="block mb-2 text-sm font-medium text-gray-400">Nome Completo</label>
                        <input type="text" id="name_${participantNumber}" name="name_${participantNumber}" class="form-input w-full p-3" required>
                    </div>
                    <div>
                        <label for="whatsapp_${participantNumber}" class="block mb-2 text-sm font-medium text-gray-400">WhatsApp</label>
                        <input type="tel" id="whatsapp_${participantNumber}" name="whatsapp_${participantNumber}" class="form-input w-full p-3" placeholder="(99) 99999-9999" required>
                    </div>
                `;
                participantsContainer.appendChild(newParticipantDiv);
                
                const newWhatsappInput = newParticipantDiv.querySelector(`#whatsapp_${participantNumber}`);
                applyWhatsappMask(newWhatsappInput);
            }

            function removeLastParticipantForm() {
                const lastParticipant = participantsContainer.lastElementChild;
                if (lastParticipant) {
                    participantsContainer.removeChild(lastParticipant);
                }
            }

            increaseBtn.addEventListener('click', () => {
                currentQuantity++;
                quantitySpan.textContent = currentQuantity;
                addParticipantForm(currentQuantity);
                updateTotalPrice();
            });

            decreaseBtn.addEventListener('click', () => {
                if (currentQuantity > 1) {
                    removeLastParticipantForm();
                    currentQuantity--;
                    quantitySpan.textContent = currentQuantity;
                    updateTotalPrice();
                }
            });
            
            ticketTypeRadios.forEach(radio => {
                radio.addEventListener('change', updateTotalPrice);
            });

            function applyWhatsappMask(inputElement) {
                 inputElement.addEventListener('input', (e) => {
                    let value = e.target.value.replace(/\D/g, '').slice(0, 11);
                    value = value.replace(/^(\d{2})(\d)/g, '($1) $2');
                    value = value.replace(/(\d)(\d{4})$/, '$1-$2');
                    e.target.value = value;
                });
            }

            function applyCPFMask(inputElement) {
                inputElement.addEventListener('input', (e) => {
                    let value = e.target.value.replace(/\D/g, '').slice(0, 11);
                    value = value.replace(/(\d{3})(\d)/, '$1.$2');
                    value = value.replace(/(\d{3})(\d)/, '$1.$2');
                    value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                    e.target.value = value;
                });
            }

            function applyCEPMask(inputElement) {
                 inputElement.addEventListener('input', (e) => {
                    let value = e.target.value.replace(/\D/g, '').slice(0, 8);
                    value = value.replace(/^(\d{5})(\d)/, '$1-$2');
                    e.target.value = value;
                });
            }
            
            applyWhatsappMask(document.getElementById('whatsapp'));
            applyCPFMask(document.getElementById('cpf'));
            applyCEPMask(document.getElementById('cep'));

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                
                loadingOverlay.classList.remove('hidden');
                loadingOverlay.classList.add('flex');

                const formData = new FormData(form);
                const mainParticipant = {
                    name: formData.get('name'),
                    email: formData.get('email'),
                    whatsapp: formData.get('whatsapp'),
                    birthdate: formData.get('birthdate'),
                    cpf: formData.get('cpf'),
                    cep: formData.get('cep'),
                };
                
                const additionalParticipants = [];
                for (let i = 2; i <= currentQuantity; i++) {
                    additionalParticipants.push({
                        name: formData.get(`name_${i}`),
                        whatsapp: formData.get(`whatsapp_${i}`)
                    });
                }

                const submissionData = {
                    mainParticipant: mainParticipant,
                    additionalParticipants: additionalParticipants,
                    ticket_type: formData.get('ticket_type'),
                    quantity: currentQuantity
                };
                
                try {
                    const response = await fetch('/api/create-preference', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(submissionData)
                    });

                    const responseData = await response.json();

                    if (!response.ok) {
                        throw new Error(responseData.details || responseData.error || 'Falha na comunicação com o servidor');
                    }

                    if (responseData.init_point) {
                        window.location.href = responseData.init_point;
                    } else {
                        throw new Error('Link de pagamento não recebido.');
                    }
                } catch (error) {
                    console.error("Erro ao processar pagamento:", error);
                    alert(`Ocorreu um erro: ${error.message}`);
                    loadingOverlay.classList.add('hidden');
                    loadingOverlay.classList.remove('flex');
                }
            });

            updateTotalPrice();
        });
    </script>
</body>
</html>
