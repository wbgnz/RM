<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validador de Bilhetes - Resenha Music</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000;
            color: #f5f5f7;
        }
        #qr-reader {
            border: 2px solid #333;
            border-radius: 12px;
            overflow: hidden;
        }
        .status-success {
            background-color: #10B981; /* Verde */
            color: white;
        }
        .status-invalid, .status-already_used, .status-error {
            background-color: #EF4444; /* Vermelho */
            color: white;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Ecrã de Login -->
    <div id="login-screen" class="w-full max-w-sm mx-auto">
        <div class="bg-[#1c1c1e] p-8 rounded-2xl shadow-lg border border-gray-700">
            <img src="https://raw.githubusercontent.com/wbgnz/BDIMG/main/resenha.jpeg" alt="Logo Resenha Music" class="h-12 mx-auto mb-6">
            <h1 class="text-2xl font-bold text-center text-white mb-6">Acesso Restrito</h1>
            <form id="login-form">
                <input type="password" id="admin-password" placeholder="Digite a senha" class="w-full bg-[#333] p-3 rounded-lg text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg mt-4 hover:bg-blue-500 transition-colors">Entrar</button>
            </form>
        </div>
    </div>

    <!-- Ecrã do Validador -->
    <div id="validator-screen" class="hidden w-full max-w-md mx-auto">
        <h1 class="text-3xl font-bold text-center text-white mb-4">Validador de Bilhetes</h1>
        <p class="text-center text-gray-400 mb-6">Aponte a câmara para o QR Code do bilhete.</p>
        <div id="qr-reader" class="w-full"></div>
        <div id="result-container" class="mt-6 p-4 rounded-lg text-center font-bold text-lg hidden"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loginScreen = document.getElementById('login-screen');
            const validatorScreen = document.getElementById('validator-screen');
            const loginForm = document.getElementById('login-form');
            const adminPasswordInput = document.getElementById('admin-password');

            let html5QrCode;

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const password = adminPasswordInput.value;
                
                try {
                    const response = await fetch('/api/admin', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'login', password: password })
                    });
                    const data = await response.json();
                    if (response.ok && data.success) {
                        sessionStorage.setItem('admin-auth-token', data.token);
                        loginScreen.classList.add('hidden');
                        validatorScreen.classList.remove('hidden');
                        startScanner();
                    } else {
                        alert(data.error || 'Senha incorreta.');
                    }
                } catch (error) {
                    alert('Erro ao tentar fazer login.');
                }
            });

            function startScanner() {
                html5QrCode = new Html5Qrcode("qr-reader");
                const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                    handleDecodedText(decodedText);
                };
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback);
            }

            async function handleDecodedText(decodedText) {
                html5QrCode.pause();
                const resultContainer = document.getElementById('result-container');
                resultContainer.textContent = 'A validar...';
                resultContainer.className = 'mt-6 p-4 rounded-lg text-center font-bold text-lg bg-gray-600 text-white';
                resultContainer.classList.remove('hidden');

                try {
                    const response = await fetch('/api/validate-ticket', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ticketId: decodedText })
                    });
                    const data = await response.json();
                    
                    resultContainer.className = `mt-6 p-4 rounded-lg text-center font-bold text-lg status-${data.status}`;
                    
                    let message = `<strong>${data.message}</strong>`;
                    if (data.participantName) {
                        message += `<br><span class="text-sm font-normal">${data.participantName}</span>`;
                    }
                     if (data.ticketType) {
                        message += `<br><span class="text-sm font-normal">Tipo: ${data.ticketType.toUpperCase()}</span>`;
                    }
                    resultContainer.innerHTML = message;

                } catch (error) {
                     resultContainer.className = 'mt-6 p-4 rounded-lg text-center font-bold text-lg status-error';
                     resultContainer.innerHTML = '<strong>ERRO DE CONEXÃO</strong><br><span class="text-sm font-normal">Não foi possível comunicar com o servidor.</span>';
                }

                setTimeout(() => {
                    resultContainer.classList.add('hidden');
                    if(html5QrCode.getState() === 2) { // 2 = PAUSED
                       html5QrCode.resume();
                    }
                }, 4000); // Mostra o resultado por 4 segundos
            }
        });
    </script>
</body>
</html>

